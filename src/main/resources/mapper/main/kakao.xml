<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dhn.client.kakao.mapper.SendRequest">

    <select id = "kaoSendDataCount" parameterType="com.dhn.client.bean.SQLParameter" resultType="int">
        SELECT count(1) AS cnt
        FROM ${msg_table}
        WHERE STATUS = '0'
          AND RESERVE_DT &lt;= SYSDATE
          AND MESSAGE_TYPE = #{msg_type}
          AND SEND_GROUP IS NULL
    </select>

    <update id="kaoGroupUpdate" parameterType="com.dhn.client.bean.SQLParameter">
        UPDATE ${msg_table}
        SET STATUS = '1',
            SEND_GROUP = #{group_no}
        WHERE STATUS = '0'
          AND RESERVE_DT &lt;= SYSDATE
          AND MESSAGE_TYPE = #{msg_type}
          AND SEND_GROUP IS NULL
          AND ROWNUM &lt;= 500
    </update>

    <select id="kaoSendDataList" parameterType="com.dhn.client.bean.SQLParameter" resultType="com.dhn.client.bean.SendData">
        SELECT
            MSG_ID AS msgid,
            MESSAGE_TYPE AS messagetype,
            MESSAGE AS msg,
            MSG AS msgsms,
            CASE
                WHEN PHN LIKE '82%' THEN PHN
                WHEN PHN LIKE '010%' THEN '82' || SUBSTR(PHN, 2, 15)
                ELSE '82' || SUBSTR(PHN, 2, 15)
                END AS phn,
            P_INVOICE as pinvoice,
            SMS_SENDER AS smssender,
            SMSLMS_TIT AS smslmstit,
            SMS_KIND as smskind,
            TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') AS regdt,
            BUTTON1 AS button1,
            BUTTON2 AS button2,
            BUTTON3 AS button3,
            BUTTON4 AS button4,
            BUTTON5 AS button5,
            TMPL_ID AS tmplid,
            PROFILE AS profile,
            '00000000000000' AS reservedt,
            TITLE as title,
            HEADER as header,
            LINK AS link,
            ATTACHMENTS as attachments,
            REAL_SEND_FLAG as realsendflag,
            SEND_GROUP as sendgroup
        FROM ${msg_table}
        WHERE SEND_GROUP = #{group_no}
    </select>

    <update id="kaoSendSuccess" parameterType="com.dhn.client.bean.SQLParameter">
        UPDATE ${msg_table}
        SET STATUS = '2',
            RESPONSE_DT = SYSDATE
        WHERE SEND_GROUP = #{group_no}
    </update>

    <update id="kaoSendFailUpdate" parameterType="com.dhn.client.bean.SQLParameter">
        UPDATE ${msg_table}
        SET STATUS = '9',
            RESPONSE_DT = SYSDATE,
            RESULT = '9999',
            RESULT_MSG = #{message}
        WHERE SEND_GROUP = #{group_no}

    </update>

    <insert id="kaoSendFailInsert" parameterType="com.dhn.client.bean.SQLParameter">
        INSERT INTO ${log_table} SELECT * FROM ${msg_table} WHERE SEND_GROUP = #{group_no}
    </insert>

    <delete id="kaoSendFailDelete" parameterType="com.dhn.client.bean.SQLParameter">
        DELETE FROM ${msg_table} WHERE SEND_GROUP = #{group_no}
    </delete>

    <update id="kaoSendRetry" parameterType="com.dhn.client.bean.SQLParameter">
        UPDATE ${msg_table}
        SET STATUS = '0',
            SEND_GROUP = NULL,
            RESPONSE_DT = NULL
        WHERE SEND_GROUP = #{group_no}
    </update>

    <update id="kaoResultUpdate" parameterType="com.dhn.client.bean.Msg_Log">
        UPDATE ${msg_table}
        SET STATUS = #{status},
            RESULT_DT = #{result_dt},
            RESULT = #{s_code},
            RESULT_MSG = #{code},
            RESULT_MESSAGE = #{result_message},
            TELCOINFO = #{telecom},
            REAL_MESSAGE_TYPE = #{real_send_type}
        WHERE MSG_ID = #{msgid}
    </update>

    <insert id="kaoLogInsert" parameterType="com.dhn.client.bean.Msg_Log">
        INSERT INTO ${log_table}
        SELECT * FROM ${msg_table}
        WHERE MSG_ID = #{msgid}
    </insert>

    <delete id="kaoResultDelete" parameterType="com.dhn.client.bean.Msg_Log">
        DELETE FROM ${msg_table}
        WHERE MSG_ID = #{msgid}
    </delete>

</mapper>
