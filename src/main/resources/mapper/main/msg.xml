<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dhn.client.msg.mapper.SendRequest">

    <select id = "msgSendDataCount" parameterType="com.dhn.client.bean.SQLParameter" resultType="int">
        SELECT count(1) AS cnt
        FROM ${msg_table}
        WHERE STATUS = '0'
          AND RESERVE_DT &lt;= SYSDATE
          AND MESSAGE_TYPE = #{msg_type}
          AND SMS_KIND = #{sms_kind}
          AND SEND_GROUP IS NULL
    </select>

    <update id="msgGroupUpdate" parameterType="com.dhn.client.bean.SQLParameter">
        UPDATE ${msg_table}
        SET STATUS = '1',
            SEND_GROUP = #{group_no}
        WHERE STATUS = '0'
          AND RESERVE_DT &lt;= SYSDATE
          AND MESSAGE_TYPE = #{msg_type}
          AND SMS_KIND = #{sms_kind}
          AND SEND_GROUP IS NULL
          AND ROWNUM &lt;= 500
    </update>

    <select id="msgSendDataList" parameterType="com.dhn.client.bean.SQLParameter" resultType="com.dhn.client.bean.SendData">
        SELECT
            MSG_ID AS msgid,
            'PH' AS messagetype,
            MSG AS msg,
            MSG AS msgsms,
            PHN AS phn,
            P_INVOICE as pinvoice,
            SMS_SENDER AS smssender,
            SMSLMS_TIT AS smslmstit,
            SMS_KIND AS smskind,
            TO_CHAR(SYSDATE, 'YYYY-MM-DD HH24:MI:SS') AS regdt,
            '00000000000000' AS reservedt,
            SEND_GROUP AS send_group
        from ${msg_table}
        where SEND_GROUP = #{group_no}
    </select>

    <update id="msgSendSuccess" parameterType="com.dhn.client.bean.SQLParameter">
        UPDATE ${msg_table}
        SET STATUS = '2',
            RESPONSE_DT = SYSDATE
        WHERE SEND_GROUP = #{group_no}
    </update>

    <update id="msgSendFailUpdate" parameterType="com.dhn.client.bean.SQLParameter">
        UPDATE ${msg_table}
        SET STATUS = '9',
            RESPONSE_DT = SYSDATE,
            RESULT = '9999',
            RESULT_MSG = #{message}
        WHERE SEND_GROUP = #{group_no}
    </update>

    <insert id="msgSendFailInsert" parameterType="com.dhn.client.bean.SQLParameter">
        INSERT INTO ${log_table} SELECT * FROM ${msg_table} WHERE SEND_GROUP = #{group_no}
    </insert>

    <delete id="msgSendFailDelete" parameterType="com.dhn.client.bean.SQLParameter">
        DELETE FROM ${msg_table} WHERE SEND_GROUP = #{group_no}
    </delete>

    <update id="msgSendRetry" parameterType="com.dhn.client.bean.SQLParameter">
        UPDATE ${msg_table}
        SET STATUS = '0',
            SEND_GROUP = NULL,
            RESPONSE_DT = NULL
        WHERE SEND_GROUP = #{group_no}
    </update>

</mapper>